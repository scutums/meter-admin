<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—á–∞—Å—Ç–∫–µ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div id="navbar-placeholder"></div>
  <div class="container py-4">
    <h2 class="mb-4">üîç –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—á–∞—Å—Ç–∫–µ</h2>
    <div id="user-info" class="mb-4"></div>
    <div class="row">
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑–∞–Ω–∏–π</h4>
          <button class="btn btn-outline-primary" onclick="generateReadingsPDF()">
            üìÑ –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç
          </button>
        </div>
        <table class="table table-bordered table-hover">
          <thead class="table-primary text-center align-middle">
            <tr>
              <th>–î–∞—Ç–∞</th>
              <th>–ü–æ–∫–∞–∑–∞–Ω–∏–µ</th>
            </tr>
          </thead>
          <tbody id="readings-table"></tbody>
        </table>
      </div>
      <div class="col-md-6">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç</h4>
          <button class="btn btn-outline-primary" onclick="generatePaymentsPDF()">
            üìÑ –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç
          </button>
        </div>
        <table class="table table-bordered table-hover">
          <thead class="table-primary text-center align-middle">
            <tr>
              <th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
              <th>–û–ø–ª–∞—á–µ–Ω–æ (–∫–í—Ç‚ãÖ—á)</th>
              <th>–¢–∞—Ä–∏—Ñ</th>
              <th>–°—É–º–º–∞</th>
              <th>–î–æ–ª–≥</th>
            </tr>
          </thead>
          <tbody id="payments-table"></tbody>
        </table>
      </div>
    </div>
    <div class="text-center mt-4">
      <button class="btn btn-primary" onclick="generateFullReport()">
        üìÑ –°–∫–∞—á–∞—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç
      </button>
    </div>
  </div>
  <script>
    async function loadNavbar() {
      const res = await fetch("/partials/nav.html");
      const html = await res.text();
      document.getElementById("navbar-placeholder").innerHTML = html;
      try {
        const token = localStorage.getItem("token");
        const resUser = await fetch("/api/auth-user-info", {
          headers: { Authorization: "Bearer " + token }
        });
        if (resUser.ok) {
          const user = await resUser.json();
          document.getElementById("username").textContent = "üë§ " + (user.full_name || user.plot_number || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å");
        } else {
          document.getElementById("username").textContent = "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
        }
      } catch {
        document.getElementById("username").textContent = "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
      }
      document.getElementById("logoutBtn")?.addEventListener("click", () => {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
      });
    }

    function formatDate(dateStr) {
      if (!dateStr) return "-";
      const date = new Date(dateStr);
      if (isNaN(date)) return "-";
      return `${String(date.getDate()).padStart(2, "0")}.${String(date.getMonth() + 1).padStart(2, "0")}.${date.getFullYear()}`;
    }

    const params = new URLSearchParams(window.location.search);
    const userId = params.get("id");
    const token = localStorage.getItem("token");

    async function loadUser() {
      const res = await fetch(`/api/users/${userId}`, {
        headers: { Authorization: "Bearer " + token }
      });
      if (!res.ok) {
        document.getElementById("user-info").innerHTML = `<div class='alert alert-danger'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>`;
        return;
      }
      const u = await res.json();
      document.getElementById("user-info").innerHTML = `
        <div class="row g-3 mb-3">
          <div class="col-md-2">
            <label class="form-label">–£—á–∞—Å—Ç–æ–∫</label>
            <div class="form-control-plaintext fw-bold fs-5">${u.plot_number}</div>
          </div>
          <div class="col-md-5">
            <label class="form-label">–§–ò–û</label>
            <div class="form-control-plaintext">${u.full_name}</div>
          </div>
          <div class="col-md-3">
            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <div class="form-control-plaintext">${u.phone || '-'}</div>
          </div>
          <div class="col-md-2">
            <label class="form-label">Viber</label>
            <div class="form-control-plaintext">
              ${u.has_viber ? '‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω' : '‚ùå –ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'}
            </div>
          </div>
        </div>
      `;
    }

    async function loadReadings() {
      const res = await fetch(`/api/user-readings/${userId}`, {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await res.json();
      const tbody = document.getElementById("readings-table");
      tbody.innerHTML = "";
      data.forEach(r => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${formatDate(r.reading_date)}</td>
          <td>${r.value}</td>
        `;
        tbody.appendChild(row);
      });
    }

    async function loadPayments() {
      const res = await fetch(`/api/user-payments/${userId}`, {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await res.json();
      const tbody = document.getElementById("payments-table");
      tbody.innerHTML = "";
      data.forEach(p => {
        const row = document.createElement("tr");
        const sum = (p.paid_reading && p.tariff) ? (p.paid_reading * p.tariff).toFixed(2) : '-';
        row.innerHTML = `
          <td>${formatDate(p.payment_date)}</td>
          <td>${p.paid_reading ?? '-'}</td>
          <td>${p.tariff ?? '-'}</td>
          <td>${sum}</td>
          <td>${p.debt ?? '-'}</td>
        `;
        tbody.appendChild(row);
      });
    }

    async function generateReadingsPDF() {
      const res = await fetch(`/api/user-readings/${userId}/pdf`, {
        headers: { Authorization: "Bearer " + token }
      });
      if (res.ok) {
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `–ø–æ–∫–∞–∑–∞–Ω–∏—è_${userId}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞');
      }
    }

    async function generatePaymentsPDF() {
      const res = await fetch(`/api/user-payments/${userId}/pdf`, {
        headers: { Authorization: "Bearer " + token }
      });
      if (res.ok) {
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `–æ–ø–ª–∞—Ç—ã_${userId}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞');
      }
    }

    async function generateFullReport() {
      const res = await fetch(`/api/user-report/${userId}/pdf`, {
        headers: { Authorization: "Bearer " + token }
      });
      if (res.ok) {
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `–ø–æ–ª–Ω—ã–π_–æ—Ç—á–µ—Ç_${userId}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞');
      }
    }

    loadNavbar();
    loadUser();
    loadReadings();
    loadPayments();
  </script>
</body>
</html> 