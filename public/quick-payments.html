<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –æ–ø–ª–∞—Ç</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="/js/auth.js"></script>
  <style>
    .table td, .table th {
      vertical-align: middle;
    }
    .unpaid-kwh, .debt {
      font-weight: bold;
      text-align: center;
    }
    .navbar-brand {
      font-weight: bold;
    }
    .row-overpaid { background-color: #cce5ff !important; }
    .row-paid { background-color: #d4edda !important; }
    .row-warning { background-color: #fff3cd !important; }
    .row-danger { background-color: #f8d7da !important; }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="container mt-4">
    <h2 class="mb-3"><span title="–û–ø–ª–∞—Ç—ã">üí∞</span> –ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –æ–ø–ª–∞—Ç</h2>
    <form class="row g-3 mb-3" id="period-form">
      <div class="col-md-3">
        <label for="period-month" class="form-label">–ú–µ—Å—è—Ü</label>
        <input type="month" id="period-month" class="form-control" required />
      </div>
      <div class="col-md-3 align-self-end">
        <button type="submit" class="btn btn-primary">–ü–æ–∫–∞–∑–∞—Ç—å</button>
      </div>
    </form>
    <div class="row mb-3">
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text">üîç</span>
          <input type="text" id="search-input" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ —É—á–∞—Å—Ç–∫—É –∏–ª–∏ –§–ò–û..." />
        </div>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered table-hover" id="payments-table">
        <thead class="table-light">
          <tr>
            <th>–£—á–∞—Å—Ç–æ–∫</th>
            <th>–§–ò–û</th>
            <th>–î–∞—Ç–∞ –ø–æ–∫–∞–∑–∞–Ω–∏–π</th>
            <th>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è</th>
            <th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
            <th>–û–ø–ª–∞—á–µ–Ω–æ (–∫–í—Ç)</th>
            <th>–†–∞—Å—Ö–æ–¥</th>
            <th>–¢–∞—Ä–∏—Ñ</th>
            <th>–°—É–º–º–∞</th>
            <th>–ù–æ–≤–∞—è –¥–∞—Ç–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
        </thead>
        <tbody id="payments-body"></tbody>
      </table>
    </div>
    <button class="btn btn-success mt-3" id="save-all">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
  </div>

  <script>
    async function loadNavbar() {
      const res = await fetch("/partials/nav.html");
      const html = await res.text();
      document.getElementById("navbar-placeholder").innerHTML = html;

      try {
        const token = localStorage.getItem("token");
        const resUser = await fetch("/api/auth-user-info", {
          headers: { Authorization: "Bearer " + token }
        });
        if (resUser.ok) {
          const user = await resUser.json();
          document.getElementById("username").textContent = "üë§ " + (user.full_name || user.plot_number || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å");
        } else {
          document.getElementById("username").textContent = "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
        }
      } catch {
        document.getElementById("username").textContent = "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
      }

      document.getElementById("logoutBtn")?.addEventListener("click", () => {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
      });
    }

    async function fetchUserStats() {
      const res = await fetch('/api/payments/last-stats', {
        headers: { Authorization: 'Bearer ' + localStorage.getItem('token') }
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', res.status, err);
        return [];
      }
      return await res.json();
    }

    async function fetchTariffs() {
      const res = await fetch('/api/tariffs', {
        headers: { Authorization: 'Bearer ' + localStorage.getItem('token') }
      });
      return await res.json();
    }

    function calculateDebt(unpaid, tariff) {
      const exact = unpaid * tariff;
      const rounded = Math.round(exact);
      return {
        exact: exact.toFixed(2),
        rounded
      };
    }

    function formatDate(dateStr) {
      if (!dateStr) return "-";
      const date = new Date(dateStr);
      if (isNaN(date)) return "-";
      return `${String(date.getDate()).padStart(2, "0")}.${String(date.getMonth() + 1).padStart(2, "0")}.${date.getFullYear()}`;
    }

    function createRow(user, tariffs) {
      const tr = document.createElement('tr');
      const last = user.last_reading || 0;
      const paid = user.paid_reading || 0;
      const unpaid = last - paid;
      const tariff = tariffs[0]?.value || 4.75;
      const overpaid = paid > last;
      const diff = Math.abs(last - paid);
      const debt = overpaid ? calculateDebt(-diff, tariff) : calculateDebt(unpaid, tariff);
      const debtValue = Math.abs(parseFloat(debt.exact));
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —Å—Ç—Ä–æ–∫–∏
      let rowBg = '';
      if (overpaid) {
        rowBg = 'background-color: #cce5ff !important;'; // —Å–∏–Ω–∏–π
      } else if (debtValue === 0) {
        rowBg = 'background-color: #d4edda !important;'; // –∑–µ–ª—ë–Ω—ã–π
      } else if (debtValue > 0 && debtValue <= 3000) {
        rowBg = 'background-color: #fff3cd !important;'; // –∂—ë–ª—Ç—ã–π
      } else if (debtValue > 3000) {
        rowBg = 'background-color: #f8d7da !important;'; // –∫—Ä–∞—Å–Ω—ã–π
      }
      tr.setAttribute('style', rowBg);

      tr.innerHTML = `
        <td>${user.plot_number}</td>
        <td>${user.full_name}</td>
        <td>${formatDate(user.last_reading_date)}</td>
        <td class="text-center" style="font-weight: normal;">${last}</td>
        <td>${formatDate(user.payment_date)}</td>
        <td><input type="number" class="form-control paid-reading" value="${paid}" min="0" ${user.payment_id ? 'disabled' : ''}></td>
        <td class="unpaid-kwh text-center" style="font-weight: normal;">${overpaid ? '+' : ''}${diff}</td>
        <td>
          <select class="form-select tariff-select" style="font-size: 0.85em;">
            ${tariffs.map(t => `<option value="${t.value}" ${t.value === tariff ? 'selected' : ''}>
              ${t.value} (${t.effective_date})
            </option>`).join('')}
          </select>
        </td>
        <td class="debt text-center">
          <div style="font-size: 1.3em; font-weight: normal;">${Math.abs(debt.rounded)}</div>
          <div style="font-size: 0.8em; color: #555; font-weight: normal;">${Math.abs(debt.exact)}</div>
        </td>
        <td><input type="date" class="form-control payment-date" value="${new Date().toISOString().split('T')[0]}" ${user.payment_id ? 'disabled' : ''}></td>
        <td style="white-space:nowrap;">
          <div style="display: flex; gap: 0.5em; align-items: center;">
            <button class="btn btn-primary pay-button" ${user.payment_id ? 'disabled' : ''}>–û–ø–ª–∞—á–µ–Ω–æ</button>
            <span class="pay-status ms-2"></span>
            ${user.payment_id ? `<button class="btn btn-danger btn-sm delete-payment" data-payment-id="${user.payment_id}" title="–£–¥–∞–ª–∏—Ç—å –æ–ø–ª–∞—Ç—É">√ó</button>` : ''}
          </div>
        </td>
      `;

      const paidInput = tr.querySelector('.paid-reading');
      const tariffSelect = tr.querySelector('.tariff-select');
      const unpaidCell = tr.querySelector('.unpaid-kwh');
      const debtCell = tr.querySelector('.debt');
      const payStatus = tr.querySelector('.pay-status');

      function updateCalc() {
        const newPaid = parseFloat(paidInput.value) || 0;
        const newUnpaid = last - newPaid;
        const newTariff = parseFloat(tariffSelect.value);
        const newOverpaid = newPaid > last;
        const newDiff = Math.abs(last - newPaid);
        unpaidCell.textContent = (newOverpaid ? '+' : '') + newDiff;
        const newDebt = newOverpaid ? calculateDebt(-newDiff, newTariff) : calculateDebt(newUnpaid, newTariff);
        debtCell.innerHTML = `
          <div style="font-size: 1.3em; font-weight: normal;">${Math.abs(newDebt.rounded)}</div>
          <div style="font-size: 0.8em; color: #555; font-weight: normal;">${Math.abs(newDebt.exact)}</div>
        `;
        let newRowBg = '';
        const newDebtValue = Math.abs(parseFloat(newDebt.exact));
        if (newOverpaid) {
          newRowBg = 'background-color: #cce5ff !important;';
        } else if (newDebtValue === 0) {
          newRowBg = 'background-color: #d4edda !important;';
        } else if (newDebtValue > 0 && newDebtValue <= 3000) {
          newRowBg = 'background-color: #fff3cd !important;';
        } else if (newDebtValue > 3000) {
          newRowBg = 'background-color: #f8d7da !important;';
        }
        tr.setAttribute('style', newRowBg);
      }

      paidInput.addEventListener('input', updateCalc);
      tariffSelect.addEventListener('change', updateCalc);

      tr.querySelector('.pay-button').addEventListener('click', async () => {
        const reading = parseFloat(paidInput.value) || 0;
        const date = tr.querySelector('.payment-date').value;

        const resp = await fetch('/api/payments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({
            user_id: user.id,
            payment_date: date,
            paid_reading: reading
          })
        });

        if (resp.ok) {
          const result = await resp.json();
          console.log('Payment saved:', result);
          payStatus.textContent = '‚úî';
          payStatus.className = 'pay-status ms-2 text-success';
          // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
          const month = document.getElementById('period-month')?.value;
          if (typeof init === 'function') init(month);
        } else {
          const err = await resp.json();
          console.error('Payment error:', err);
          payStatus.textContent = '–û—à–∏–±–∫–∞';
          payStatus.className = 'pay-status ms-2 text-danger';
        }
      });

      return tr;
    }

    async function init(month) {
      await loadNavbar();
      const [users, tariffs] = await Promise.all([fetchUserStats(), fetchTariffs()]);
      const tbody = document.getElementById('payments-body');
      tbody.innerHTML = "";
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
      window.allUsers = users;
      window.currentTariffs = tariffs;
      
      filterAndDisplayUsers(month);
    }

    function filterAndDisplayUsers(month, searchText = '') {
      const tbody = document.getElementById('payments-body');
      tbody.innerHTML = "";
      
      const filteredUsers = window.allUsers.filter(user => {
        // –§–∏–ª—å—Ç—Ä –ø–æ –º–µ—Å—è—Ü—É
        const matchesMonth = user.last_reading_date && user.last_reading_date.startsWith(month);
        
        // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É
        const searchLower = searchText.toLowerCase();
        const matchesSearch = !searchText || 
          (user.plot_number && user.plot_number.toLowerCase().includes(searchLower)) ||
          (user.full_name && user.full_name.toLowerCase().includes(searchLower));
        
        return matchesMonth && matchesSearch;
      });

      filteredUsers.forEach(user => {
        const tr = createRow(user, window.currentTariffs);
        tbody.appendChild(tr);
      });
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞
    document.getElementById('search-input').addEventListener('input', (e) => {
      const month = document.getElementById('period-month').value;
      filterAndDisplayUsers(month, e.target.value);
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –ø–µ—Ä–∏–æ–¥–∞
    document.getElementById("period-form").addEventListener("submit", function(e) {
      e.preventDefault();
      const month = document.getElementById("period-month").value;
      const searchText = document.getElementById('search-input').value;
      filterAndDisplayUsers(month, searchText);
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã
    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('delete-payment')) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ–ø–ª–∞—Ç—É?')) return;
        const paymentId = e.target.getAttribute('data-payment-id');
        if (!paymentId) return;
        const resp = await fetch(`/api/payments/${paymentId}`, {
          method: 'DELETE',
          headers: { Authorization: 'Bearer ' + localStorage.getItem('token') }
        });
        if (resp.ok) {
          // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã
          const month = document.getElementById('period-month').value;
          const searchText = document.getElementById('search-input').value;
          filterAndDisplayUsers(month, searchText);
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã');
        }
      }
    });

    function getCurrentMonth() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
    }
    document.getElementById("period-month").value = getCurrentMonth();
    document.getElementById("period-form").addEventListener("submit", function(e) {
      e.preventDefault();
      const month = document.getElementById("period-month").value;
      init(month);
    });
    init(getCurrentMonth());
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
