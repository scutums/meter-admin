<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –æ–ø–ª–∞—Ç</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }

    header {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
    }

    .user-info {
      font-size: 14px;
    }

    nav {
      background-color: #0056b3;
      padding: 10px 20px;
      display: flex;
      gap: 20px;
    }

    nav a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }

    nav a:hover {
      text-decoration: underline;
    }

    main {
      padding: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f4f4f4;
    }

    input[type="number"], input[type="date"], select {
      width: 100%;
      padding: 6px;
    }

    button {
      padding: 6px 12px;
      margin-top: 10px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      tr {
        margin-bottom: 20px;
      }
      th {
        display: none;
      }
      td {
        border: none;
        position: relative;
        padding-left: 50%;
      }
      td::before {
        position: absolute;
        left: 10px;
        width: 45%;
        white-space: nowrap;
        font-weight: bold;
      }
      td:nth-child(1)::before { content: "–ù–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞"; }
      td:nth-child(2)::before { content: "–§–ò–û"; }
      td:nth-child(3)::before { content: "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è"; }
      td:nth-child(4)::before { content: "–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–∫–∞–∑–∞–Ω–∏–π"; }
      td:nth-child(5)::before { content: "–ü–æ—Å–ª–µ–¥–Ω—è—è –¥–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã"; }
      td:nth-child(6)::before { content: "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è"; }
      td:nth-child(7)::before { content: "–†–∞—Å—Ö–æ–¥ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã"; }
      td:nth-child(8)::before { content: "–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ"; }
      td:nth-child(9)::before { content: "–û–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∫–í—Ç‚ãÖ—á"; }
      td:nth-child(10)::before { content: "–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã"; }
      td:nth-child(11)::before { content: "–¢–∞—Ä–∏—Ñ"; }
      td:nth-child(12)::before { content: "–î–µ–π—Å—Ç–≤–∏—è"; }
    }
  </style>
</head>
<body>
  <header>
    <h1>–£—á—ë—Ç –µ–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏</h1>
    <div class="user-info">
      <span id="user-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span> |
      <a href="#" onclick="logout()" style="color:white; text-decoration: underline;">–í—ã–π—Ç–∏</a>
    </div>
  </header>

  <nav>
    <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
    <a href="quick-entry.html">–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –ø–æ–∫–∞–∑–∞–Ω–∏–π</a>
    <a href="quick-payments.html">–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –æ–ø–ª–∞—Ç</a>
  </nav>

  <main>
    <table id="payments-table">
      <thead>
        <tr>
          <th>–ù–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞</th>
          <th>–§–ò–û</th>
          <th>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è</th>
          <th>–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–∫–∞–∑–∞–Ω–∏–π</th>
          <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –¥–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
          <th>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è</th>
          <th>–†–∞—Å—Ö–æ–¥ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã</th>
          <th>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ</th>
          <th>–û–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∫–í—Ç‚ãÖ—á</th>
          <th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
          <th>–¢–∞—Ä–∏—Ñ</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="payments-body">
        <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞ -->
      </tbody>
    </table>
    <button id="save-all">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
  </main>

  <script>
    function logout() {
      localStorage.removeItem('token');
      window.location.href = "login.html";
    }

    document.getElementById('user-name').textContent = localStorage.getItem('userLogin') || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

    async function fetchUsers() {
      const response = await fetch('/api/users', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      return await response.json();
    }

    async function fetchTariffs() {
      const response = await fetch('/api/tariffs', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      return await response.json();
    }

    function calculateDebt(unpaid_kwh, tariff) {
      return (unpaid_kwh * tariff).toFixed(2);
    }

    function createRow(user, tariffs) {
      const tr = document.createElement('tr');

      const lastReading = user.last_reading || 0;
      const paidReading = user.paid_reading || 0;
      const unpaidKwh = lastReading - paidReading;
      const defaultTariff = tariffs[0]?.value || 4.75;
      const debt = calculateDebt(unpaidKwh, defaultTariff);

      tr.innerHTML = `
        <td>${user.plot_number}</td>
        <td>${user.full_name}</td>
        <td>${lastReading}</td>
        <td>${user.last_reading_date || ''}</td>
        <td>${user.payment_date || ''}</td>
        <td>${paidReading}</td>
        <td class="unpaid-kwh">${unpaidKwh}</td>
        <td class="debt">${debt}</td>
        <td><input type="number" class="paid-reading" value="${paidReading}" min="0" /></td>
        <td><input type="date" class="payment-date" value="${new Date().toISOString().split('T')[0]}" /></td>
        <td>
          <select class="tariff-select">
            ${tariffs.map(tariff => `
              <option value="${tariff.value}" ${tariff.value === defaultTariff ? 'selected' : ''}>
                ${tariff.value} –≥—Ä–Ω (—Å ${tariff.effective_date})
              </option>
            `).join('')}
          </select>
        </td>
        <td><button class="pay-button">üí∞ –û–ø–ª–∞—á–µ–Ω–æ</button></td>
      `;

      const paidReadingInput = tr.querySelector('.paid-reading');
      const tariffSelect = tr.querySelector('.tariff-select');
      const unpaidKwhCell = tr.querySelector('.unpaid-kwh');
      const debtCell = tr.querySelector('.debt');

      function updateCalculations() {
        const newPaidReading = parseFloat(paidReadingInput.value) || 0;
        const newUnpaidKwh = lastReading - newPaidReading;
        const selectedTariff = parseFloat(tariffSelect.value);
        unpaidKwhCell.textContent = newUnpaidKwh;
        debtCell.textContent = calculateDebt(newUnpaidKwh, selectedTariff);
      }

      paidReadingInput.addEventListener('input', updateCalculations);
      tariffSelect.addEventListener('change', updateCalculations);

      tr.querySelector('.pay-button').addEventListener('click', async () => {
        const paymentDate = tr.querySelector('.payment-date').value;
        const paidReading = parseFloat(paidReadingInput.value) || 0;

        const response = await fetch('/api/payments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({
            user_id: user.id,
            payment_date: paymentDate,
            paid_reading: paidReading
          })
        });

        if (response.ok) {
          alert('–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        } else {
          const error = await response.json();
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã: ' + error.message);
        }
      });

      return tr;
    }

    document.getElementById('save-all').addEventListener('click', async () => {
      const rows = document.querySelectorAll('#payments-body tr');
      for (const tr of rows) {
        tr.querySelector('.pay-button').click();
      }
    });

    async function init() {
      const [users, tariffs] = await Promise.all([fetchUsers(), fetchTariffs()]);
      const tbody = document.getElementById('payments-body');
      users.forEach(user => {
        const row = createRow(user, tariffs);
        tbody.appendChild(row);
      });
    }

    init();
  </script>
</body>
</html>
