<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –æ–ø–ª–∞—Ç</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .table td, .table th {
      vertical-align: middle;
    }
    .unpaid-kwh, .debt {
      font-weight: bold;
      text-align: center;
    }
    .navbar-brand {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="container mt-4">
    <h2 class="mb-3">–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –æ–ø–ª–∞—Ç</h2>
    <div class="table-responsive">
      <table class="table table-bordered table-hover" id="payments-table">
        <thead class="table-light">
          <tr>
            <th>–£—á–∞—Å—Ç–æ–∫</th>
            <th>–§–ò–û</th>
            <th>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è</th>
            <th>–î–∞—Ç–∞ –ø–æ–∫–∞–∑–∞–Ω–∏–π</th>
            <th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
            <th>–û–ø–ª–∞—á–µ–Ω–æ (–∫–í—Ç)</th>
            <th>–†–∞—Å—Ö–æ–¥</th>
            <th>–¢–∞—Ä–∏—Ñ</th>
            <th>–°—É–º–º–∞</th>
            <th>–ù–æ–≤–∞—è –¥–∞—Ç–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
        </thead>
        <tbody id="payments-body"></tbody>
      </table>
    </div>
    <button class="btn btn-success mt-3" id="save-all">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
  </div>

  <script>
    async function loadNavbar() {
      const res = await fetch("/partials/nav.html");
      const html = await res.text();
      document.getElementById("navbar-placeholder").innerHTML = html;

      try {
        const token = localStorage.getItem("token");
        const payload = JSON.parse(atob(token.split('.')[1]));
        document.getElementById("username").textContent = "üë§ " + payload.login;
      } catch {
        document.getElementById("username").textContent = "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
      }

      document.getElementById("logoutBtn")?.addEventListener("click", () => {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
      });
    }

    async function fetchUsers() {
      const res = await fetch('/api/users', {
        headers: { Authorization: 'Bearer ' + localStorage.getItem('token') }
      });
      return await res.json();
    }

    async function fetchTariffs() {
      const res = await fetch('/api/tariffs', {
        headers: { Authorization: 'Bearer ' + localStorage.getItem('token') }
      });
      return await res.json();
    }

    function calculateDebt(unpaid, tariff) {
      return (unpaid * tariff).toFixed(2);
    }

    function createRow(user, tariffs) {
      const tr = document.createElement('tr');
      const last = user.last_reading || 0;
      const paid = user.paid_reading || 0;
      const unpaid = last - paid;
      const tariff = tariffs[0]?.value || 4.75;

      tr.innerHTML = `
        <td>${user.plot_number}</td>
        <td>${user.full_name}</td>
        <td>${formatDate(user.last_reading_date) || ''}</td>
        <td class="text-center">${last}</td>
        <td>${formatDate(user.payment_date) || ''}</td>
        <td><input type="number" class="form-control paid-reading" value="${paid}" min="0"></td>
        <td class="unpaid-kwh text-center">${unpaid}</td>
        <td>
          <select class="form-select tariff-select">
            ${tariffs.map(t => `<option value="${t.value}" ${t.value === tariff ? 'selected' : ''}>
              ${t.value} –≥—Ä–Ω (—Å ${t.effective_date})
            </option>`).join('')}
          </select>
        </td>
        <td class="debt text-center">${calculateDebt(unpaid, tariff)}</td>
        <td><input type="date" class="form-control payment-date" value="${new Date().toISOString().split('T')[0]}"></td>
        <td><button class="btn btn-primary pay-button">–û–ø–ª–∞—á–µ–Ω–æ</button></td>
      `;

      const paidInput = tr.querySelector('.paid-reading');
      const tariffSelect = tr.querySelector('.tariff-select');
      const unpaidCell = tr.querySelector('.unpaid-kwh');
      const debtCell = tr.querySelector('.debt');

      function updateCalc() {
        const newPaid = parseFloat(paidInput.value) || 0;
        const newUnpaid = last - newPaid;
        const newTariff = parseFloat(tariffSelect.value);
        unpaidCell.textContent = newUnpaid;
        debtCell.textContent = calculateDebt(newUnpaid, newTariff);
      }

      paidInput.addEventListener('input', updateCalc);
      tariffSelect.addEventListener('change', updateCalc);

      tr.querySelector('.pay-button').addEventListener('click', async () => {
        const reading = parseFloat(paidInput.value) || 0;
        const date = tr.querySelector('.payment-date').value;

        const resp = await fetch('/api/payments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({
            user_id: user.id,
            payment_date: date,
            paid_reading: reading
          })
        });

        if (resp.ok) alert('‚úÖ –û–ø–ª–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        else {
          const err = await resp.json();
          alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message);
        }
      });

      return tr;
    }

    document.getElementById('save-all').addEventListener('click', () => {
      document.querySelectorAll('.pay-button').forEach(btn => btn.click());
    });

    async function init() {
      await loadNavbar();
      const [users, tariffs] = await Promise.all([fetchUsers(), fetchTariffs()]);
      const tbody = document.getElementById('payments-body');
      users.forEach(user => tbody.appendChild(createRow(user, tariffs)));
    }

    init();

     function formatDate(dateStr) {
      if (!dateStr) return "-";
      const date = new Date(dateStr);
      if (isNaN(date)) return "-";
      return `${String(date.getDate()).padStart(2, "0")}.${String(date.getMonth() + 1).padStart(2, "0")}.${date.getFullYear()}`;
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
