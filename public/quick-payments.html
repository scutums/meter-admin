<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –æ–ø–ª–∞—Ç</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    input[type="number"], input[type="date"], select { width: 100%; padding: 6px; }
    button { padding: 6px 12px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –æ–ø–ª–∞—Ç</h1>
  <table id="payments-table">
    <thead>
      <tr>
        <th>–ù–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞</th>
        <th>–§–ò–û</th>
        <th>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è</th>
        <th>–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–∫–∞–∑–∞–Ω–∏–π</th>
        <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –¥–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
        <th>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è</th>
        <th>–†–∞—Å—Ö–æ–¥ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã</th>
        <th>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ</th>
        <th>–û–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∫–í—Ç‚ãÖ—á</th>
        <th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
        <th>–¢–∞—Ä–∏—Ñ</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody id="payments-body">
      <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞ -->
    </tbody>
  </table>
  <button id="save-all">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>

  <script>
    async function fetchUsers() {
      const response = await fetch('/api/users', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const users = await response.json();
      return users;
    }

    async function fetchTariffs() {
      const response = await fetch('/api/tariffs', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const tariffs = await response.json();
      return tariffs;
    }

    function createTariffOptions(tariffs) {
      return tariffs.map(tariff => {
        const option = document.createElement('option');
        option.value = tariff.value;
        option.textContent = `${tariff.value} –≥—Ä–Ω (—Å ${tariff.effective_date})`;
        return option;
      });
    }

    function calculateDebt(unpaid_kwh, tariff) {
      return (unpaid_kwh * tariff).toFixed(2);
    }

    function createRow(user, tariffs) {
      const tr = document.createElement('tr');

      const lastReading = user.last_reading || 0;
      const paidReading = user.paid_reading || 0;
      const unpaidKwh = lastReading - paidReading;
      const defaultTariff = tariffs[0]?.value || 4.75;
      const debt = calculateDebt(unpaidKwh, defaultTariff);

      tr.innerHTML = `
        <td>${user.plot_number}</td>
        <td>${user.full_name}</td>
        <td>${lastReading}</td>
        <td>${user.last_reading_date || ''}</td>
        <td>${user.payment_date || ''}</td>
        <td>${paidReading}</td>
        <td class="unpaid-kwh">${unpaidKwh}</td>
        <td class="debt">${debt}</td>
        <td><input type="number" class="paid-reading" value="${paidReading}" min="0" /></td>
        <td><input type="date" class="payment-date" value="${new Date().toISOString().split('T')[0]}" /></td>
        <td>
          <select class="tariff-select">
            ${tariffs.map(tariff => `
              <option value="${tariff.value}" ${tariff.value === defaultTariff ? 'selected' : ''}>
                ${tariff.value} –≥—Ä–Ω (—Å ${tariff.effective_date})
              </option>
            `).join('')}
          </select>
        </td>
        <td><button class="pay-button">üí∞ –û–ø–ª–∞—á–µ–Ω–æ</button></td>
      `;

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      const paidReadingInput = tr.querySelector('.paid-reading');
      const tariffSelect = tr.querySelector('.tariff-select');
      const unpaidKwhCell = tr.querySelector('.unpaid-kwh');
      const debtCell = tr.querySelector('.debt');

      function updateCalculations() {
        const newPaidReading = parseFloat(paidReadingInput.value) || 0;
        const newUnpaidKwh = lastReading - newPaidReading;
        const selectedTariff = parseFloat(tariffSelect.value);
        unpaidKwhCell.textContent = newUnpaidKwh;
        debtCell.textContent = calculateDebt(newUnpaidKwh, selectedTariff);
      }

      paidReadingInput.addEventListener('input', updateCalculations);
      tariffSelect.addEventListener('change', updateCalculations);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã
      const payButton = tr.querySelector('.pay-button');
      payButton.addEventListener('click', async () => {
        const paymentDate = tr.querySelector('.payment-date').value;
        const paidReading = parseFloat(paidReadingInput.value) || 0;

        const response = await fetch('/api/payments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({
            user_id: user.id,
            payment_date: paymentDate,
            paid_reading: paidReading
          })
        });

        if (response.ok) {
          alert('–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        } else {
          const error = await response.json();
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã: ' + error.message);
        }
      });

      return tr;
    }

    document.getElementById('save-all').addEventListener('click', async () => {
      const rows = document.querySelectorAll('#payments-body tr');
      for (const tr of rows) {
        const payButton = tr.querySelector('.pay-button');
        payButton.click();
      }
    });

    async function init() {
      const [users, tariffs] = await Promise.all([fetchUsers(), fetchTariffs()]);
      const tbody = document.getElementById('payments-body');
      users.forEach(user => {
        const row = createRow(user, tariffs);
        tbody.appendChild(row);
      });
    }

    init();
  </script>
</body>
</html>
