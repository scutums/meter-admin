<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –ø–æ–∫–∞–∑–∞–Ω–∏–π</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4">üìä –ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –ø–æ–∫–∞–∑–∞–Ω–∏–π</h2>
    <table class="table table-bordered table-sm table-hover">
      <thead class="table-primary text-center">
        <tr>
          <th>‚Ññ</th>
          <th>–§–ò–û</th>
          <th>–ü—Ä–µ–¥. –ø–æ–∫–∞–∑–∞–Ω–∏–µ</th>
          <th>–î–∞—Ç–∞</th>
          <th>–ù–æ–≤–æ–µ</th>
        </tr>
      </thead>
      <tbody id="quick-input-body"></tbody>
    </table>
    <button class="btn btn-success mt-3" onclick="saveAll()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "/login.html";

    function formatDate(dateStr) {
      if (!dateStr) return "-";
      const date = new Date(dateStr);
      if (isNaN(date)) return "-";
      return `${String(date.getDate()).padStart(2, "0")}.${String(date.getMonth() + 1).padStart(2, "0")}.${date.getFullYear()}`;
    }

    async function loadUsers() {
      const res = await fetch("/api/users", {
        headers: { Authorization: "Bearer " + token },
      });
      const users = await res.json();
      const tbody = document.getElementById("quick-input-body");
      tbody.innerHTML = "";

      users.forEach((u, index) => {
        const tr = document.createElement("tr");
        tr.dataset.userId = u.id;
        tr.dataset.prev = u.last_reading ?? "";

        tr.innerHTML = `
          <td>${u.plot_number}</td>
          <td>${u.full_name}</td>
          <td>${u.last_reading ?? "-"}</td>
          <td>${formatDate(u.last_reading_date)}</td>
          <td>
            <input type="number" class="form-control reading-input" 
                   id="reading-${u.id}" 
                   oninput="markChanged(this)"
                   onkeydown="handleEnter(event)" />
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function markChanged(input) {
      const row = input.closest("tr");
      row.classList.add("table-warning");
      const prev = parseFloat(row.dataset.prev);
      const curr = parseFloat(input.value);
      if (!isNaN(prev) && !isNaN(curr) && curr < prev) {
        input.classList.add("is-invalid");
        input.title = "–ù–æ–≤–æ–µ –ø–æ–∫–∞–∑–∞–Ω–∏–µ –º–µ–Ω—å—à–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ!";
      } else {
        input.classList.remove("is-invalid");
        input.title = "";
      }
    }

    function handleEnter(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        const inputs = [...document.querySelectorAll(".reading-input")];
        const index = inputs.indexOf(event.target);
        if (index >= 0 && index < inputs.length - 1) {
          inputs[index + 1].focus();
        }
      }
    }

    async function saveAll() {
      const rows = document.querySelectorAll("#quick-input-body tr");
      const today = new Date().toISOString().split("T")[0];

      for (const row of rows) {
        const input = row.querySelector("input");
        const value = input.value;
        const userId = row.dataset.userId;

        if (!value) continue;

        const res = await fetch("/api/readings", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({
            user_id: userId,
            reading_date: today,
            value: value,
          }),
        });

        if (res.ok) {
          input.classList.remove("is-invalid");
          input.classList.add("is-valid");
          row.classList.remove("table-warning");
          row.classList.add("table-success");
        } else {
          input.classList.add("is-invalid");
        }
      }
    }

    loadUsers();
  </script>
</body>
</html>
